(function(){var engines={};var detectType=function(input){return typeof input};var each=function(list,iterator,callback){var syncEach=function(list,iterator){if(isArray(list)&&!isEmpty(list)){for(var i=0,len=list.length;i<len;i++){iterator.apply(list,[i,list[i]])}}if(isObject(list)&&!isEmpty(list)){for(var key in list){if(list.hasOwnProperty(key)){iterator.apply(list,[key,list[key]])}}}};var asyncEach=function(list,iterator,callback){var queue=[];var addToQueue=function(key,value){var index=queue.length+1;queue.push(function(){var next=function(error){var fn=queue[index];if(!error&&fn){return fn()}else if(!error&&!fn){return callback()}else{return callback(error)}};return iterator(key,value,next)})};if(isArray(list)&&!isEmpty(list)){for(var i=0,len=list.length;i<len;i++){addToQueue(i,list[i])}}else if(isObject(list)&&!isEmpty(list)){for(var key in list){if(list.hasOwnProperty(key)){addToQueue(key,list[key])}}}else{return callback()}return queue[0]()};if(typeof callback==="undefined"){return syncEach.apply(this,arguments)}else{return asyncEach.apply(this,arguments)}};var every=function(arr,iterator){return Array.prototype.every.apply(arr,[iterator])};var filter=function(arr,iterator,context){return Array.prototype.filter.apply(arr,[iterator,context||this])};var hasProperty=function(obj,property){return Object.prototype.hasOwnProperty.apply(obj,[property])};var isArray=function(input){return Object.prototype.toString.call(input)==="[object Array]"};var isBoolean=function(input){return typeof input==="boolean"};var isDefined=function(input){return typeof input!=="undefined"};var isEmpty=function(input){if(isNumber(input)){return false}if(input===null){return true}if(isArray(input)||typeof input==="string"){return input.length===0}if(isObject(input)){for(var key in input){if(hasOwnProperty.call(input,key))return false}}return true};var isEqual=function(obj1,obj2){if(isArray(obj1,obj2)){if(obj1.length!==obj2.length){return false}return every(obj1,function(value,index,context){return obj2[index]===value})}if(isObject(obj1,obj2)){var keys1=keys(obj1),keys2=keys(obj2);if(!isEqual(keys1,keys2)){return false}for(key in obj1){if(!obj2[key]||obj1[key]!==obj2[key]){return false}}return true}return false};var isFunction=function(input){return typeof input==="function"};var isInteger=function(input){return isNumber(input)&&input%1===0};var isNull=function(input){return input===null};var isNumber=function(input){return typeof input==="number"};var isObject=function(input){return Object.prototype.toString.call(input)==="[object Object]"};var isString=function(input){return typeof input==="string"};var isUndefined=function(input){return typeof input==="undefined"};var keys=function(obj){return Object.keys(obj)};var merge=function(obj1,obj2){for(var key in obj2){if(obj2.hasOwnProperty(key)&&!obj1.hasOwnProperty(key)){obj1[key]=obj2[key]}}return obj1};var pluck=function(list,propertyName){var output=[];for(var i=0,len=list.length;i<len;i++){var property=list[i][propertyName];if(output.indexOf(property)===-1){output.push(property)}}return output};var returnTrue=function(){return true};var some=function(arr,iterator){return Array.prototype.some.apply(arr,[iterator])};(function(){var Validation=function(options){var self=this;var defaultOptions={singleError:true,messages:errorMessages,cache:false};each(defaultOptions,function(key,value){if(isObject(value)&&options[key]){self[key]=merge(options[key],defaultOptions[key])}else if(isObject(value)&&!options[key]){self[key]=merge({},defaultOptions[key])}else{self[key]=isDefined(options[key])?options[key]:defaultOptions[key]}});this.errors=new ValidationError(this)};Validation.prototype.attributes={};Validation.prototype.addAttribute=function(attributeName,attributeFn){return Validation.prototype.attributes[attributeName]=attributeFn};Validation.prototype.addAttributeConstructor=function(attributeName,attributeConstructor){return Validation.prototype.attributes[attributeName]=attributeConstructor()};var additionalPropertiesAttribute=function additionalProperties(property,propertyValue,attributeValue,propertyAttributes,callback){var self=this;if(attributeValue===true){return callback()}var propertyKeys=keys(propertyValue);var forbiddenProperties=filter(propertyKeys,function(key){return!propertyAttributes.properties[key]});if(isEmpty(forbiddenProperties)){return callback()}if(attributeValue===false){forbiddenProperties.forEach(function(forbiddenProperty){this.addError({property:this.joinPath(property,forbiddenProperty),propertyValue:propertyValue[forbiddenProperty]})},this);return callback()}if(isObject(attributeValue)){return each(forbiddenProperties,function(index,key,callback){return self.validateSchema(propertyValue[key],attributeValue,property+key,callback)},callback)}};Validation.prototype.addAttribute("additionalProperties",additionalPropertiesAttribute);var divisibleByAttribute=function divisibleBy(property,propertyValue,attributeValue,propertyAttributes,callback){if(attributeValue===0){throw new Error("The value of this attribute should not be 0.")}if(isNumber(propertyValue)&&propertyValue%attributeValue!==0){this.addError()}return callback()};Validation.prototype.addAttribute("divisibleBy",divisibleByAttribute);var enumAttribute=function(property,propertyValue,attributeValue,propertyAttributes,callback){if(attributeValue.indexOf(propertyValue)===-1){this.addError()}return callback()};Validation.prototype.addAttribute("enum",enumAttribute);var exceptAttribute=function except(property,propertyValue,attributeValue,propertyAttributes,callback){if(attributeValue.indexOf(propertyValue)!==-1){this.addError()}return callback()};Validation.prototype.addAttribute("except",exceptAttribute);Validation.prototype.addAttributeConstructor("format",function formatConstructor(){var self=this;var formats={"date-time":{type:"string",pattern:/^\d{4}-(?:0[0-9]{1}|1[0-2]{1})-[0-9]{2}T\d{2}:\d{2}:\d{2}\.\d{3}Z$/},date:function(input){if(isString(input)){return input.match(/^\d{4}-(?:0[0-9]{1}|1[0-2]{1})-[0-9]{2}$/)}if(isObject(input)){return Object.prototype.toString.call(input)==="[object Date]"}return false},time:{type:"string",pattern:/^\d{2}:\d{2}:\d{2}$/},"utc-milisec":{type:"number"},regex:function(input){return input&&input.test&&input.exec},color:{type:"string"},style:{type:"string"},phone:{type:"number"},uri:{type:"string",pattern:/^(?:(?:ht|f)tp(?:s?)\:\/\/|~\/|\/)?(?:\w+:\w+@)?((?:(?:[-\w\d{1-3}]+\.)+(?:com|org|cat|coop|int|pro|tel|xxx|net|gov|mil|biz|info|mobi|name|aero|jobs|edu|co\.uk|ac\.uk|it|fr|tv|museum|asia|local|travel|[a-z]{2})?)|((\b25[0-5]\b|\b[2][0-4][0-9]\b|\b[0-1]?[0-9]?[0-9]\b)(\.(\b25[0-5]\b|\b[2][0-4][0-9]\b|\b[0-1]?[0-9]?[0-9]\b)){3}))(?::[\d]{1,5})?(?:(?:(?:\/(?:[-\w~!$+|.,=]|%[a-f\d]{2})+)+|\/)+|\?|#)?(?:(?:\?(?:[-\w~!$+|.,*:]|%[a-f\d{2}])+=?(?:[-\w~!$+|.,*:=]|%[a-f\d]{2})*)(?:&(?:[-\w~!$+|.,*:]|%[a-f\d{2}])+=?(?:[-\w~!$+|.,*:=]|%[a-f\d]{2})*)*)*(?:#(?:[-\w~!$ |\/.,*:;=]|%[a-f\d]{2})*)?$/},email:{type:"string",pattern:/^(?:[\w\!\#\$\%\&\'\*\+\-\/\=\?\^\`\{\|\}\~]+\.)*[\w\!\#\$\%\&\'\*\+\-\/\=\?\^\`\{\|\}\~]+@(?:(?:(?:[a-zA-Z0-9](?:[a-zA-Z0-9\-](?!\.)){0,61}[a-zA-Z0-9]?\.)+[a-zA-Z0-9](?:[a-zA-Z0-9\-](?!$)){0,61}[a-zA-Z0-9]?)|(?:\[(?:(?:[01]?\d{1,2}|2[0-4]\d|25[0-5])\.){3}(?:[01]?\d{1,2}|2[0-4]\d|25[0-5])\]))$/},"ip-address":{type:"string",pattern:/^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/},ipv6:{type:"string",pattern:/(?:(?:[a-f\d]{1,4}:)*(?:[a-f\d]{1,4}|\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})|(?:(?:[a-f\d]{1,4}:)*[a-f\d]{1,4})?::(?:(?:[a-f\d]{1,4}:)*(?:[a-f\d]{1,4}|\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}))?)/},"host-name":{type:"string"}};formats.alpha={required:true,type:"string",pattern:/^[a-zA-Z]+$/};formats.alphanumeric={required:true,type:["string","number"],pattern:/^[a-zA-Z0-9]+$/};formats.decimal=function(input){if(!isNumber(input))return false;return(input+"").match(/^[0-9]+(\.[0-9]{1,2})?$/)};formats.percentage={required:true,type:["string","number"],pattern:/^-?[0-9]{0,2}(\.[0-9]{1,2})?$|^-?(100)(\.[0]{1,2})?$/,minimum:-100,maximum:100};formats.port={required:true,type:["string","number"],pattern:/\:\d+/};var aliases={url:"uri",ip:"ip-address",ipv4:"ip-address",host:"host-name",hostName:"host-name"};each(aliases,function(alias,format){formats[alias]=formats[format]});return function format(property,propertyValue,attributeValue,propertyAttributes,callback){if(isObject(attributeValue)){return this.validateProperty(property,propertyValue,attributeValue,callback)}if(isString(attributeValue)&&!hasProperty(formats,attributeValue)){throw new Error("The format ‘"+attributeValue+"’ is not supported.")}if(isString(attributeValue)){var fn=formats[attributeValue];if(isFunction(fn)){var noError=fn(propertyValue);if(!noError){this.addError()}return callback()}if(isObject(fn)){return this.validateProperty(property,propertyValue,fn,callback)}}}});var lengthAttribute=function length(property,propertyValue,attributeValue,propertyAttributes,callback){if(isString(propertyValue)&&propertyValue.length!==attributeValue){this.addError()}return callback()};Validation.prototype.addAttribute("length",lengthAttribute);var maximumAttribute=function maximum(property,propertyValue,attributeValue,propertyAttributes,callback){if(isNumber(propertyValue)){if(propertyAttributes.exclusiveMaximum&&propertyValue>=attributeValue||propertyValue>attributeValue){this.addError()}}return callback()};Validation.prototype.addAttribute("maximum",maximumAttribute);var maxItemsAttribute=function maxItems(property,propertyValue,attributeValue,propertyAttributes,callback){if(isArray(propertyValue)&&propertyValue.length>attributeValue){this.addError()}return callback()};Validation.prototype.addAttribute("maxItems",maxItemsAttribute);var maxLengthAttribute=function maxLength(property,propertyValue,attributeValue,propertyAttributes,callback){if(isString(propertyValue)&&propertyValue.length>attributeValue){this.addError()}return callback()};Validation.prototype.addAttribute("maxLength",maxLengthAttribute);var minimumAttribute=function minimum(property,propertyValue,attributeValue,propertyAttributes,callback){if(isNumber(propertyValue)){if(propertyAttributes.exclusiveMinimum&&propertyValue<=attributeValue||propertyValue<attributeValue){this.addError()}}return callback()};Validation.prototype.addAttribute("minimum",minimumAttribute);var minItems=function minItems(property,propertyValue,attributeValue,propertyAttributes,callback){if(isArray(propertyValue)&&propertyValue.length<attributeValue){this.addError()}return callback()};Validation.prototype.addAttribute("minItems",minItems);var minLengthAttribute=function minLength(property,propertyValue,attributeValue,propertyAttributes,callback){if(isString(propertyValue)&&propertyValue.length<attributeValue){this.addError()}return callback()};Validation.prototype.addAttribute("minLength",minLengthAttribute);var patternAttribute=function pattern(property,propertyValue,attributeValue,propertyAttributes,callback){if(isString(propertyValue)&&!propertyValue.match(attributeValue)){this.addError()}return callback()};Validation.prototype.addAttribute("pattern",patternAttribute);(function(){var attribute=function patternProperties(property,propertyValue,attributeValue,propertyAttributes,callback){var self=this;if(isEmpty(attributeValue)){return callback()}var matches={};var patterns=keys(attributeValue);each(propertyValue,function(key,value){each(patterns,function(index,pattern){if(key.match(new RegExp(pattern))){matches[key]=attributeValue[pattern]}})});if(isEmpty(matches)){return callback()}each(matches,function(propertyName,propertySchema,callback){return self.validateSchema(propertyValue[propertyName],propertySchema,self.joinPath(property,propertyName),callback)},callback)};Validation.prototype.addAttribute("patternProperties",attribute)})();var requiredAttribute=function required(property,propertyValue,attributeValue,propertyAttributes,callback){if(attributeValue){var undefinedCondition=isUndefined(propertyValue);var emptyCondition=(isString(propertyValue)||isArray(propertyValue)||isObject(propertyValue))&&isEmpty(propertyValue);if(undefinedCondition||emptyCondition){this.addError()}}return callback()};Validation.prototype.addAttribute("required",requiredAttribute);var typeConstructor=function typeConstructor(){var types={string:isString,number:isNumber,"function":isFunction,"boolean":isBoolean,object:isObject,array:isArray,integer:isInteger,"int":isInteger,"null":isNull,any:returnTrue};return function type(property,propertyValue,attributeValue,propertyAttributes,callback){if(isArray(attributeValue)){var noError=attributeValue.some(function(type){if(!hasProperty(types,type)){throw new Error("Type ‘"+attributeValue+"’ is not supported.")}return types[type](propertyValue)});if(!noError){this.addError()}return callback()}else{if(!hasProperty(types,attributeValue)){throw new Error("Type ‘"+attributeValue+"’ is not supported.")}if(!types[attributeValue](propertyValue)){this.addError()}return callback()}}};Validation.prototype.addAttributeConstructor("type",typeConstructor);(function(){var attribute=function uniqueItems(property,propertyValue,attributeValue,propertyAttributes,callback){var self=this;each(propertyValue,function(index,value){if(isString(value)){if(propertyValue.indexOf(value)<index){self.addError()}}if(isObject(value)||isArray(value)){propertyValue.forEach(function(subValue,subIndex){if(subIndex!==index){if(isEqual(value,subValue)){self.addError({property:self.joinPath(property,subIndex)})}}})}});return callback()};Validation.prototype.addAttribute("uniqueItems",attribute)})();var ValidationError=function(parent){this.length=0;this.errorMessages=parent.messages};ValidationError.prototype.renderErrorMessage=function(error){var errorMessage=this.errorMessages[error.attributeName];if(errorMessage&&isFunction(errorMessage)){return errorMessage(error.property,error.propertyValue,error.attributeValue)}if(errorMessage&&isString(errorMessage)){["property","propertyValue","attributeValue"].forEach(function(placeholder){errorMessage=errorMessage.replace(new RegExp("{{"+placeholder+"}}","g"),error[placeholder])});errorMessage=errorMessage.replace(/{{validator}}/g,error["attributeValue"]);return errorMessage.replace(/\s+/g," ")}return error.message};ValidationError.prototype.push=function(error){this[this.length]={property:error.property,propertyValue:error.propertyValue,attributeName:error.attributeName,attributeValue:error.attributeValue,message:this.renderErrorMessage(error),validator:error.attributeName,validatorName:error.attributeName,validatorValue:error.attributeValue};this.length+=1};ValidationError.prototype.getProperties=function(){return pluck(this,"property")};ValidationError.prototype.getMessages=function(){return pluck(this,"message")};var errorMessages={required:function(property,propertyValue,attributeValue){return"The ‘"+property+"’ property is required."},minLength:function(property,propertyValue,attributeValue){return["The "+property+" property must be at least "+attributeValue+" characters.","The length of the property is "+propertyValue.length+"."].join(" ")},maxLength:function(property,propertyValue,attributeValue){return["The "+property+" property must not exceed "+attributeValue+" characters.","The length of the property is "+propertyValue.length+"."].join(" ")},length:function(property,propertyValue,attributeValue){return["The "+property+" property must be exactly "+attributeValue+" characters.","The length of the property is "+propertyValue.length+"."].join(" ")},format:function(property,propertyValue,attributeValue){return["The ‘"+property+"’ property must be a/an ‘"+attributeValue+"’.","The current value of the property is ‘"+propertyValue+"’"].join(" ")},type:function(property,propertyValue,attributeValue){return["The ‘"+property+"’ property must be a/an ‘"+attributeValue+"’.","The type of the property is ‘"+detectType(propertyValue)+"’"].join(" ")},except:function(property,propertyValue,attributeValue){return},minimum:function(property,propertyValue,attributeValue){return["The minimum value of the ‘"+property+"’ must be "+attributeValue+".","The current value of the property is ‘"+propertyValue+"’"].join(" ")},maximum:function(property,propertyValue,attributeValue){return["The maximum value of the ‘"+property+"’ must be "+attributeValue+".","The current value of the property is ‘"+propertyValue+"’."].join(" ")},pattern:function(property,propertyValue,attributeValue){return"The ‘"+property+"’ does not match the ‘"+attributeValue+"’ pattern."},maxItems:function(property,propertyValue,attributeValue){return["The ‘"+property+"’ property must not contain more than ‘"+attributeValue+"’ items.","Currently it contains ‘"+propertyValue.items+"’ items."].join(" ")},minItems:function(property,propertyValue,attributeValue){return["The ‘"+property+"’ property must contain at least ‘"+attributeValue+"’ items.","Currently it contains ‘"+propertyValue.items+"’ items."].join(" ")},divisibleBy:function(property,propertyValue,attributeValue){return"The ‘"+property+"’ is not divisible by ‘"+attributeValue+"’."},uniqueItems:function(property,propertyValue,attributeValue){return"All items in the ‘"+property+"’ property must be unique."},"enum":function(property,propertyValue,attributeValue){return"Value of the ‘"+property+"’ must be "+attributeValue.join(" or ")+"."}};Validation.prototype.getProperty=function(property,source){var tree=property.match(/([a-zA-Z0-9\s]+)/g);return tree.reduce(function(previousValue,currentValue,index){return previousValue&&isDefined(previousValue[currentValue])?previousValue[currentValue]:undefined},source)};Validation.prototype.joinPath=function(path,property){path=path||"";property=property+"";if(property.match(/^[a-zA-Z]+$/)){return path?path+"."+property:property}else if(property.match(/\d+/)){return path+"["+property+"]"}else{return path+'["'+property+'"]'}};Validation.prototype.validate=function(instance,schema,callback){var self=this;this.instance=instance;this.schema=schema;var basicTypes=["string","number","function","boolean","integer","int","null"];var objectTypes=["object","array"];var callbackProxy=function(){if(self.errors.length!==0){return callback(self.errors)}else{return callback()}};if(basicTypes.indexOf(schema.type)!==-1){return this.validateProperty(undefined,instance,schema,callbackProxy)}if(objectTypes.indexOf(schema.type)!==-1){if(isString(instance)){try{instance=JSON.parse(instance)}catch(parseError){}}return this.validateSchema(instance,schema,"",callbackProxy)}if(schema.type==="any"||!schema.type){if(isString(instance)){try{instance=JSON.parse(instance);return this.validateSchema(instance,schema,"",callbackProxy)}catch(parseError2){}}if(isObject(instance)||isArray(instance)){return this.validateSchema(instance,schema,"",callbackProxy)}return this.validateProperty(undefined,instance,schema,callbackProxy)}};Validation.prototype.validateItems=function(instance,schema,path,callback){var self=this;if(isArray(schema.items)){if(isUndefined(schema.additionalItems)||schema.additionalItems===true){return each(schema.items,function(itemIndex,itemSchema,callback){return self.validateSchema(instance[itemIndex],itemSchema,self.joinPath(path,itemIndex),callback)},callback)}return each(instance,function(itemIndex,itemValue,callback){if(schema.items[itemIndex]||isObject(schema.additionalItems)){return self.validateSchema(itemValue,schema.items[itemIndex],self.joinPath(path,itemIndex),callback)}if(schema.additionalItems===false){self.errors.push({property:self.joinPath(path,itemIndex),propertyValue:itemValue,attributeName:"additionalItems",attributeValue:false});return callback()}},callback)}if(isObject(schema.items)&&instance&&!isEmpty(instance)){return each(instance,function(itemIndex,itemValue,callback){return self.validateSchema(instance[itemIndex],schema.items,self.joinPath(path,itemIndex),callback)},callback)}else{return callback()}};Validation.prototype.validateProperties=function(instance,schema,path,callback){var self=this;return each(schema.properties,function(property,propertyAttributes,callback){var isObject=propertyAttributes.type==="object"&&propertyAttributes.properties,isArray=propertyAttributes.type==="array";var propertyValue=self.getProperty(property,instance);var propertyPath=self.joinPath(path,property);if(isObject||isArray){return self.validateSchema(propertyValue,schema.properties[property],propertyPath,callback)}else{return self.validateProperty(propertyPath,propertyValue,propertyAttributes,callback)}},callback)};Validation.prototype.validateProperty=function(property,propertyValue,propertyAttributes,callback){var self=this;var context={};["validateItems","validateProperties","validateSchema","validateProperty","getProperty","attributes","errors","joinPath"].forEach(function(key){context[key]=this[key]},self);var iterator=function(attributeName,attributeFn,callback){var lastLength=self.errors.length;context.addError=function(message){if(isObject(message)){return self.errors.push({property:message.property||property,propertyValue:message.propertyValue||propertyValue,attributeName:message.attributeName||attributeName,attributeValue:message.attributeValue||propertyAttributes[attributeName],message:message.message||undefined})}return self.errors.push({property:property,propertyValue:propertyValue,attributeName:attributeName,attributeValue:propertyAttributes[attributeName],message:message})};var onComplete=function(error){if(error===true||isString(error)){context.addError(error);return callback(true)}if(self.errors.length>lastLength&&self.singleError){return callback(true)}else{return callback()}};if(isDefined(propertyAttributes[attributeName])){return attributeFn.apply(context,[property,propertyValue,propertyAttributes[attributeName],propertyAttributes,onComplete])}else{return callback()}};if(propertyAttributes.required!==true&&isUndefined(propertyValue)){return callback()}return each(self.attributes,iterator,callback)};Validation.prototype.validateSchema=function(instance,schema,path,callback){var self=this;return self.validateProperty(path,instance,schema,function(error){if(schema.properties){return self.validateProperties(instance,schema,path,callback)}else if(schema.items){return self.validateItems(instance,schema,path,callback)}else{return callback()}})};engines.json=function(){var cache=[];var cacheIndex={};return{validate:function(instance,schema,options,callback){if(typeof options==="function"){callback=options;options={}}return new Validation(options).validate(instance,schema,callback)},addAttribute:function(attributeName,attributeFn){return Validation.prototype.addAttribute.apply(Validation,arguments)},addAttributeConstructor:function(attributeName,attributeConstructor){return Validation.prototype.addAttributeConstructor.apply(Validation,arguments)}}}()})();var amanda=function(engine){if(!hasProperty(engines,engine)){throw new Error("The ‘"+engine+"’ engine is not supported. Please use a different one.")}return engines[engine]};amanda.validate=function(instance,schema,options,callback){var json=engines.json;return json.validate.apply(json,arguments)};amanda.addValidator=function(attributeName,attributeFn){var json=engines.json;return json.addAttribute.apply(json,arguments)};amanda.addAttribute=function(attributeName,attributeFn){var json=engines.json;return json.addAttribute.apply(json,arguments)};amanda.addAttributeConstructor=function(attributeName,attributeConstructor){var json=engines.json;return json.addAttributeConstructor.apply(json,arguments)};if(typeof module!=="undefined"&&module.exports){module.exports=amanda}else if(typeof define!=="undefined"){define(function(){return amanda})}else{this.amanda=amanda}})();